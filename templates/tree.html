<!DOCTYPE html>
<html lang="{{ get_locale() }}">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Keerikandy Family-Tree </title>
  <style>
html[lang="ml"] body {
  letter-spacing: 0.4px;
  word-spacing: 1px;
  line-height: 1.75;
}

html[lang="ml"] .btn {
  
  font-size: 0.45rem;
  white-space: normal;
  text-align: center;
}

html[lang="ml"] .container h2,
html[lang="ml"] .first-profile-container h2,
html[lang="ml"] .contain h2 {
  font-size: 1.1rem;
  letter-spacing: 0.3px;
}

html[lang="ml"] .site-title {
  font-size: 1.54rem;
}

@media (max-width: 600px) {
  html[lang="ml"] .site-title {
    font-size: 1.38rem;
  }

  html[lang="ml"] .btn {
    font-size: 0.5rem;
    padding: 10px 10px;
    text-align: center;
    
  }
  html[lang="ml"] .children h4{
    font-size: .9rem;
  }
  html[lang="ml"] .container h2,
  html[lang="ml"] .first-profile-container h2,
  html[lang="ml"] .contain h2 {
    font-size: 1rem;
  }
  html[lang="ml"] .member-actions a.btn-add{
  text-align: center;
  padding-bottom: 30px;
}
}



:root {
  --primary: #0077b6;
  --primary-dark: #005f91;
  --secondary: #6c757d;
  --secondary-dark: #545b62;
  --warning: #f39c12;
  --warning-dark: #d78b0d;
  --success: #28a745;
  --info: #007bff;
  --danger: #dc3545;
  --background: #f4f6f9;
  --white: #ffffff;
  --text: #333333;
  --light-border: #e0e0e0;
  --light-grey: #f9f9f9;
  --shadow: 0 3px 15px rgba(0, 0, 0, 0.1);
}

/* Reset */
html, body {
  margin: 0;
  padding: 0;
  overflow-x: hidden;
}

html {
  font-size: 16px;
}

body {
  background: var(--background);
  font-family: 'Segoe UI', sans-serif;
  color: var(--text);
  line-height: 1.5;
}

/* Header */
.site-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--primary);
  color: var(--white);
  padding: 12px 16px;
  width: 100%;
}

.menu-btn {
  background: none;
  border: none;
  color: var(--white);
  cursor: pointer;
  font-size: 1.4rem;
  width: 48px;
  height: 24px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin: 0;
}

.menu-btn:hover {
  color: var(--primary-dark);
}

.site-title {
  flex: none;
  text-align: center;
  font-size: 1.8rem;
  font-weight: bold;
  margin-left: -17px;
}

.menu-placeholder {
  display: inline-block;
  width: 48px;
  height: 24px;
}

/* Responsive header tweaks only */
@media (max-width: 600px) {
  .site-header {
    padding: 12px;
  }
  .site-title {
    font-size: 1.6rem;
    margin-left: -24px;
  }
  .menu-btn {
    font-size: 1.2rem;
    width: 36px;
    height: 24px;
  }
  .menu-placeholder {
    width: 36px;
  }
}

/* Tree page title */
.tree-title {
  text-align: center;
  color: var(--primary);
  font-size: 2rem;
  margin-bottom: 30px;
  font-weight: 600;
  margin-left: 9px;
}

/* Tree header buttons */
.tree-header {
  display: flex;
  justify-content: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 15px;
}

.tree-header a {
  display: inline-block;
  color: var(--white);
  background: var(--primary);
  text-decoration: none;
  padding: 10px 20px;
  border-radius: 4px;
  font-weight: 600;
  font-size: 1rem;
  transition: background 0.3s ease;
}

.tree-header a:hover {
  background: var(--primary-dark);
}

/* Container */
.container {
  max-width: 960px;
  margin: 40px auto;
  background: var(--white);
  padding: 30px;
  border-radius: 12px;
  box-shadow: var(--shadow);
  border: 1px solid var(--light-border);
}

/* Tree container - wrap member boxes */
.tree-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
}

/* Member box */
.member-box {
  border: 1px solid var(--light-border);
  border-radius: 10px;
  background: var(--white);
  padding: 15px  ;
  margin: 15px;
  width: 250px;
  text-align: center;
  display: block;
  box-shadow: var(--shadow);
  transition: transform 0.3s;
}
.member-box {
    width: 100%;
    max-width: 230px;
    margin: 10px auto;
    padding: 8px 6px;
  }
.member-box:hover {
  transform: translateY(-5px);
}

.member-box img {
  width: 100px;
  height: 100px;
  object-fit: cover;
  border-radius: 50%;
  margin-bottom: 10px;
  border: 2px solid var(--primary);
}

.member-box h3 {
  margin: 10px 0 5px 0;
  font-size: 1.2rem;
  color: var(--primary-dark);
}

.member-box p {
  margin: 4px 0;
  font-size: 0.95rem;
  color: #555;
}
.late-label {
  color: red;
  font-weight: bold;
  margin-left: 4px;
  font-size: 0.9em;
}

/* Family toggle */
.toggle-family {
  cursor: pointer;
  color: var(--primary-dark);
  text-decoration: underline;
  margin-top: 8px;
  display: inline-block;
  font-weight: 600;
  font-size: 0.9rem;
}

.hidden {
  display: none;
}

.family-section {
  margin-top: 15px;
}

.children {
  margin-left: 40px;
  border-left: 2px dashed var(--light-border);
  padding-left: 20px;
  margin-top: 15px;
}

h4 {
  margin-top: 10px;
  color: var(--primary);
  font-size: 1.2rem;
}
.tree-search {
  text-align: center;
  margin-bottom: 20px;
}

.tree-search input {
  width: 300px;
  max-width: 90%;
  padding: 10px;
  border: 1px solid var(--light-border);
  border-radius: 6px;
  font-size: 1rem;
}

/* Buttons */
.btn {
  padding: 10px 20px;
  margin: 5px;
  font-size: 1rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  display: inline-block;
  text-decoration: none;
  font-weight: 600;
  transition: background 0.3s ease;
  margin-left: 12px;
}

.btn-back {
  background: var(--secondary);
  color: var(--white);
}

.btn-back:hover {
  background: var(--secondary-dark);
}

.btn-add {
  background: var(--success);
  color: var(--white);
}

.btn-add:hover {
  background: #218838;
}

.btn-edit {
  background: var(--info);
  color: var(--white);
}

.btn-edit:hover {
  background: #0069d9;
}

.btn-delete {
  background: var(--danger);
  color: var(--white);
}

.btn-delete:hover {
  background: #c82333;
}

/* Sidebar */
#sidebar {
  position: fixed;
  top: 0;
  left: -250px;
  width: 250px;
  height: 100%;
  background: var(--primary);
  color: #fff;
  padding-top: 60px;
  transition: left 0.3s ease;
  z-index: 9999;
}

#sidebar a {
  display: block;
  color: #fff;
  padding: 15px 20px;
  text-decoration: none;
  font-weight: 600;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

#sidebar a:hover {
  background: var(--primary-dark);
}

#sidebar #closeBtn {
  position: absolute;
  top: 20px;
  right: 20px;
  font-size: 28px;
  cursor: pointer;
}

#sidebar a.active-sidebar {
  background: #28a745;
  color: #fff;
}

/* Responsive tweaks for header and buttons only */
@media (max-width: 768px) {
  .tree-header {
    flex-direction: column;
    text-align: center;
  }

  .tree-header a {
    width: 100%;
    margin: 12px 0;
    font-size: 1.2rem;
    padding: 14px 20px;
  }

  .btn {
    width: auto;
    font-size: 0.8rem;
    padding: 6px 10px;
    margin: 8px;
  }
}

@media (max-width: 600px) {
  .container {
    width: 70%;
    max-width: 100%;
    margin: 90px auto;
    padding: 240px;
    border-radius: 0;
    box-shadow: none;
     
   margin-left:-200px;
   margin-top:0px;
    margin-bottom:0px;
    background: var(--background);
 border: 0px solid var(--light-border);
  border-radius: 0px;
  
  }
}
@media (max-width: 600px) {
   .tree-title {
    margin-left: 35px;
    margin-top: -230px;
    font-size: 1.6rem;
    
  }
}

@media (max-width: 600px) {
  .member-box {
    width: 100%;
    max-width: 180px;
    margin: 10px auto  ;
    padding: 8px 6px ;
    
  }

  .member-box img {
    width: 70px;
    height: 70px;
    margin-bottom: 6px;
  }

  .member-box h3 {
    font-size: 0.95rem;
    margin: 6px 0 4px 0;
  }

  .member-box p {
    font-size: 0.78rem;
    margin: 2px 0;
  }

  .btn {
    font-size: 0.5rem;
    padding: 4px 4px;
    margin: 4px 4px;
  }

  .toggle-family {
    font-size: 0.6rem;
    margin-top: 6px;
  }
 
}

@media (max-width: 600px) {
  .tree-container {
    justify-content: flex-start;
    padding-left: 16px;
    margin-left: -135px;
    margin-top: -20px;
  }
}
.highlighted {
  background-color: #fff9c4 !important;
}

/* Fixed Next Match button */
.fixed-next-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
}

/* Align search input and button heights and reduce gap */
.search-bar input {
  flex: 1 1 auto;
  min-width: 0;
  width: 100%;
  height: 30px;
  padding: 0 12px;
  font-size: 1rem;
}

.search-bar .btn {
  flex: 0 0 auto;
  height: 30px;
  padding: 0 4px;
  font-size: 0.8rem;
  margin-left: 0;
}


.search-bar {
  display: flex;
  flex-wrap: nowrap;
  justify-content: center;
  align-items: center;
  gap: 2px;
  width: 100%;
  max-width: 400px;
  margin: 0 auto;
}

@media (max-width: 600px) {
  .search-bar input,
  .search-bar .btn {
    height: 22px;
    font-size: 0.7rem;
  }
}



.fixed-buttons {
  position: fixed;
  bottom: 10px;
  right: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 9999;
}

/* Desktop buttons */
.btn.btn-add.small-btn {
  background: var(--success);
  color: var(--white);
  font-size: 0.75rem;
  padding: 6px 10px;
  min-width: 70px;
}

.btn.btn-add.small-btn:hover {
  background: #218838;
}

.btn.btn-back.small-btn {
  background: var(--secondary);
  color: var(--white);
  font-size: 0.75rem;
  padding: 6px 10px;
  min-width: 70px;
}

.btn.btn-back.small-btn:hover {
  background: var(--secondary-dark);
}

/* Mobile button tweaks */
@media (max-width: 600px) {
  .fixed-buttons {
    position: fixed;
    bottom: 10px;
    right: 10px;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
  }

  .btn.small-btn {
    font-size: 0.55rem;
    padding: 4px 6px;
    min-width: 80px;
    margin: 0;
  }

  #scrollTopBtn.btn.small-btn {
    font-size: 0.5rem;
    padding: 3px 5px;
    min-width: 50px;
  }
  #nextMatchBtn.btn.small-btn {
  font-size: 0.5rem;
  padding: 3px 5px;
  min-width: 50px;
}

}

.tree-header a.btn-back {
  font-size: 0.85rem;
  padding: 6px 12px;
  margin-top: -10px;
}

/* Mobile adjustment */
@media (max-width: 600px) {
  .tree-header a.btn-back {
    font-size: 0.50rem;
    padding: 2px 6px;
    margin-top: -25px;
    max-width: 80px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-left: 110px;
  }
  
}
.member-actions {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0px;
  
}
.member-actions.hidden {
  display: none;
  
}



/* Optional: button spacing improvements */
.member-actions .btn {
  font-size: 0.60rem;
  padding: 4px 8px;
  width: 79px;
  height: 20px;
  min-width: 60px;
  box-sizing: border-box;
  text-align: center;
}
.nickname-label {
  color: #6c757d; /* a subtle grey that looks elegant */
  font-weight: bold;
  font-size: 0.9em;
  margin-left: 2px;
  
}

</style>
</head>
<body>
  <header class="site-header">
    {% if mode != "login" %}
      <button id="menuBtn" class="menu-btn">☰</button>
    {% else %}
      <span class="menu-placeholder"></span>
    {% endif %}
    <span class="site-title">{{_('Keerikandy Family')}}</span>
    {% if mode != "login" %}
      <span class="menu-placeholder"></span>
    {% else %}
      <span class="menu-placeholder"></span>
    {% endif %}
  </header>

  <div class="container">
    <h2 class="tree-title">{{ _('Family Tree') }}</h2>
    

    <div class="tree-header">
      <a href="{{ url_for('dashboard') }}" class="btn btn-back">← {{_('Back to Dashboard')}}</a>
    </div>
    
<div class="tree-search">
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="{{_('Search member by Name or Nickname')}}" />
    <button id="searchBtn" class="btn btn-add" title="{{_('Search')}}">{{_('Search')}}</button>
  </div>
  <div id="searchResultMsg" style="margin-top: 10px; color: var(--primary-dark); font-weight: 600;"></div>
</div>
  {% macro render_member(member_id, tree, collapsed=True) %}
    {% set member = tree[member_id]["member"] %}
    <div class="member-box" data-member="{{ member.id }}">
      {% if member.selfie_path %}
        <img src="{{ member.selfie_path }}" alt="Selfie">
      {% else %}
        <img src="https://via.placeholder.com/100" alt="No Photo">
      {% endif %}
<h3>
  {{ member.name }}
  {% if member.is_late %}
    <span class="late-label">({{_('Late')}})</span>
  {% elif member.nickname %}
    <span class="nickname-label">({{ member.nickname }})</span>
  {% endif %}
</h3>


      <p><strong>{{_('DOB')}}:</strong> {{ member.dob }}</p>
      <p><strong>{{ _('Gender') }}:</strong>
  {% if member.gender == 'Male' %}
    {{ _('Male') }}
  {% elif member.gender == 'Female' %}
    {{ _('Female') }}
  {% elif member.gender == 'Other' %}
    {{ _('Other') }}
  {% else %}
    {{ '-' }}
  {% endif %}
</p>

      <p><strong>{{_('Blood Group')}}:</strong> {{ member.blood_group }}</p>
      <p><strong>{{_('Job/Education')}}:</strong> {{ member.job_or_education }}</p>

      {% if current_user.role in ["Admin", "Contributor"] %}
        <button type="button" class="btn btn-add toggle-actions-btn">{{_('Add / Update')}}</button>
        <div class="member-actions hidden">
          
          {% if not member.is_spouse %}
            <a href="{{ url_for('add_member', related_to=member.id, relation='child') }}" class="btn btn-add">{{_('Add Child')}}</a>
            {% if member.gender == 'Male' %}
              <a href="{{ url_for('add_member', related_to=member.id, relation='spouse') }}" class="btn btn-add">{{_('Add Wife')}}</a>
            {% elif member.gender == 'Female' %}
              <a href="{{ url_for('add_member', related_to=member.id, relation='spouse') }}" class="btn btn-add">{{_('Add Husband')}}</a>
            {% endif %}
          {% endif %}
          <a href="{{ url_for('edit_member', member_id=member.id) }}" class="btn btn-edit">{{_('Edit')}}</a>
          {% if current_user.role == 'Admin' %}
            <form method="POST" action="{{ url_for('delete_member', member_id=member.id) }}" style="display:inline;">
              <button type="submit" class="btn btn-delete" onclick="return confirm('Are you sure you want to delete this member?');">{{_('Delete')}}</button>
            </form>
          {% endif %}
        </div>
      {% endif %}

      {% if tree[member_id]["spouse"] or tree[member_id]["children"] %}
        <div class="toggle-family">{{_('Show Family')}} ▼</div>
      {% endif %}

      <div class="family-section {% if collapsed %}hidden{% endif %}">
        {% if tree[member_id]["spouse"] %}
          <div class="children">
            <h4>{{_('Spouse(s)')}}:</h4>
            {% for spouse_id in tree[member_id]["spouse"] %}
              {{ render_member(spouse_id, tree, collapsed=True) }}
            {% endfor %}
          </div>
        {% endif %}
        
          {% if tree[member_id]["children"] %}
          <h4>{{_('Children')}}:</h4>
  <div class="tree-row">
    {% for child_id in tree[member_id]["children"] %}
      {{ render_member(child_id, tree, collapsed=True) }}
    {% endfor %}
  </div>
{% endif %}
        
      </div>
    </div>
  {% endmacro %}

  <div class="tree-container">
  {% if root_id %}
    {{ render_member(root_id, tree, collapsed=True) }}
  {% else %}
    <p>{{_('No root member found')}}.</p>
  {% endif %}
</div>

</div>
<div class="fixed-buttons">
  <button id="nextMatchBtn" class="btn btn-add small-btn" style="display:none;">
    {{_('Next')}} →
  </button>
  <button id="scrollTopBtn" class="btn btn-back small-btn" style="display:none;">
    ↑
  </button>
</div>
<div id="sidebar">
  <span id="closeBtn">&times;</span>
  
  <a href="{{ url_for('dashboard') }}"
     class="{% if mode == 'dashboard' %}active-sidebar{% endif %}">{{_('Dashboard')}}</a>
  
  <a href="{{ url_for('tree') }}"
     class="{% if mode == 'tree' %}active-sidebar{% endif %}">{{_('View Family Tree')}}</a>
  
  {% if user.role == "Admin" %}
    <a href="{{ url_for('admin') }}"
       class="{% if mode == 'admin' %}active-sidebar{% endif %}">{{_('Manage Users')}}</a>
  {% endif %}
  <a href="{{ url_for('bloodgroup_page') }}"
   class="{% if mode == 'bloodgroup' %}active-sidebar{% endif %}">
   {{_('Blood Group')}}
</a>

  <a href="{{ url_for('logout') }}">{{_('Logout')}}</a>
</div>
<script>
 
  const HIDE_FAMILY_TEXT = "{{ _('Hide Family') }} ▲";
  const SHOW_FAMILY_TEXT = "{{ _('Show Family') }} ▼";


document.addEventListener("DOMContentLoaded", function() {
  let matches = [];
  let currentMatchIndex = 0;

  const searchInput = document.getElementById("searchInput");
  const searchBtn = document.getElementById("searchBtn");
  const nextMatchBtn = document.getElementById("nextMatchBtn");
  const scrollTopBtn = document.getElementById("scrollTopBtn");
  const searchResultMsg = document.getElementById("searchResultMsg");

  function runSearch() {
    const term = searchInput.value.trim().toLowerCase();
    matches = [];
    currentMatchIndex = 0;

    const memberBoxes = document.querySelectorAll(".member-box");
    const familySections = document.querySelectorAll(".family-section");
    const toggles = document.querySelectorAll(".toggle-family");

    if (term !== "") {
      // Show all members and expand all family sections
      memberBoxes.forEach(box => {
        box.style.display = "block";        // show all members
        box.classList.remove("highlighted"); // remove previous highlights
      });

      familySections.forEach(section => {
        section.classList.remove("hidden"); // fully expand all family branches
      });

      toggles.forEach(toggle => {
        toggle.textContent = HIDE_FAMILY_TEXT;
 // update toggles to expanded state
      });

      // Highlight matching members and collect matches
      memberBoxes.forEach(box => {
        const nameElement = box.querySelector("h3");
        if (nameElement) {
          const nameText = nameElement.textContent.toLowerCase();
          if (nameText.includes(term)) {
            box.classList.add("highlighted");
            matches.push(box);
          }
        }
      });

      // Show feedback & navigation buttons
      if (matches.length > 0) {
        searchResultMsg.textContent = `${matches.length} ${matches.length === 1 ? "{{ _('person') }}" : "{{ _('people') }}"} {{ _('found') }}`;

        nextMatchBtn.style.display = matches.length > 1 ? "inline-block" : "none";
        scrollTopBtn.style.display = "inline-block";
        scrollToBox(matches[0]);
      } else {
        searchResultMsg.textContent = "{{ _('No matching members found') }}";
        nextMatchBtn.style.display = "none";
        scrollTopBtn.style.display = "none";

      }

    } else {
      // Reset all member boxes to visible and remove highlights
      memberBoxes.forEach(box => {
        box.style.display = "block";
        box.classList.remove("highlighted");
      });

      // Collapse all family sections (hide children/spouses)
      familySections.forEach(section => {
        section.classList.add("hidden");
      });

      // Reset toggle buttons to "Show Family ▼"
      toggles.forEach(toggle => {
      toggle.textContent = SHOW_FAMILY_TEXT;
        });

      // Clear search result message
      searchResultMsg.textContent = "";

      // Hide navigation buttons
      nextMatchBtn.style.display = "{{_('none')}}";
      scrollTopBtn.style.display = "{{_('none')}}";
    }
  }

  function expandDescendants(box) {
    // Recursively expand all nested children
    const sections = box.querySelectorAll(".family-section");
    sections.forEach(section => {
      section.classList.remove("hidden");
      const toggle = section.previousElementSibling;
      if (toggle && toggle.classList.contains("toggle-family")) {
        toggle.textContent = HIDE_FAMILY_TEXT;

      }
    });
  }

  function scrollToBox(box) {
    document.querySelectorAll(".member-box").forEach(b => b.classList.remove("active-scroll"));

    const boxRect = box.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const targetTop = scrollTop + boxRect.top - (window.innerHeight / 2);

    window.scrollTo({
      top: targetTop,
      behavior: "smooth"
    });

    box.classList.add("active-scroll");
  }

  if (searchBtn) {
    searchBtn.addEventListener("click", runSearch);
  }

  if (searchInput) {
    searchInput.addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        e.preventDefault();
        runSearch();
      }
    });
    searchInput.addEventListener("keyup", function() {
      if (searchInput.value.trim() === "") {
        runSearch(); // Reset the tree view when search is cleared
      }
    });
  }

  if (nextMatchBtn) {
    nextMatchBtn.addEventListener("click", function() {
      if (matches.length > 0) {
        currentMatchIndex = (currentMatchIndex + 1) % matches.length;
        scrollToBox(matches[currentMatchIndex]);
      }
    });
  }

  if (scrollTopBtn) {
    scrollTopBtn.addEventListener("click", function() {
      window.scrollTo({
        top: 0,
        behavior: "smooth"
      });
    });
  }

  // Toggle family section show/hide on click
  document.querySelectorAll(".toggle-family").forEach(function(toggle) {
    toggle.addEventListener("click", function() {
      const section = this.nextElementSibling;
      if (section.classList.contains("hidden")) {
        section.classList.remove("hidden");
toggle.textContent = HIDE_FAMILY_TEXT;
      } else {
        section.classList.add("hidden");
toggle.textContent = SHOW_FAMILY_TEXT;
      }
    });
  });

  // Toggle Add / Update buttons inside member boxes
  document.addEventListener("click", function(e) {
    if (e.target && e.target.classList.contains("toggle-actions-btn")) {
      console.log("Toggle button clicked");

      const btn = e.target;
      const memberBox = btn.closest(".member-box");
      if (!memberBox) {
        console.log("No member box found!");
        return;
      }

      const actions = memberBox.querySelector(".member-actions");
      if (actions) {
        actions.classList.toggle("hidden");
        console.log("Toggled hidden class. Now hidden?", actions.classList.contains("hidden"));
      } else {
        console.log("No .member-actions element found inside member box.");
      }
    }
  });
  const sidebar = document.getElementById("sidebar");
const menuBtn = document.getElementById("menuBtn");
const closeBtn = document.getElementById("closeBtn");

if (menuBtn && sidebar) {
  menuBtn.addEventListener("click", function () {
    sidebar.style.left = "0"; // slide in
  });
}

if (closeBtn && sidebar) {
  closeBtn.addEventListener("click", function () {
    sidebar.style.left = "-250px"; // slide out
  });
}

});

</script>
</body>
</html>
